<script>
document.getElementById("feedbackForm").addEventListener("submit", function(e){
    e.preventDefault();

    const name = document.getElementById("name").value;
    const affiliation = document.getElementById("affiliation").value;
    const email = document.getElementById("email").value;
    const rating = document.getElementById("rating").value;
    const comment = document.getElementById("comment").value;

    console.log("Submitting:", name, affiliation, email);

    // EMAIL CHECK (GET â€“ most reliable)
    fetch(
      "https://script.google.com/macros/s/AKfycbyWCDkwectVdS-Jn4Z33K0LbyRbNLj-gyd6lmegkEFgeoucSz81-VXnLyvnePkt9-2x/exec?email=" 
      + encodeURIComponent(email)
    )
    .then(r => r.text())
    .then(t => {
        console.log("Email API response:", t);

        if (!t.toLowerCase().includes("allowed")) {
            alert("Email not authorized");
            throw "STOP";
        }

        // SAVE FEEDBACK
        return fetch(
          "https://script.google.com/macros/s/AKfycbx0gp1KKA70SkvYu5Kp4c02JLxyFlrvyQMOovozToWn5Z9jL8-eTUK4MrXVt5JZI3Wp/exec",
          {
            method: "POST",
            body: JSON.stringify({
              name, affiliation, email, rating, comment
            })
          }
        );
    })
    .then(() => {
        window.location.href =
          "certificate.html?name=" + encodeURIComponent(name) +
          "&affiliation=" + encodeURIComponent(affiliation);
    })
    .catch(err => {
        if (err !== "STOP") {
            console.error(err);
            alert("Submission failed. Check console.");
        }
    });
});
</script>
