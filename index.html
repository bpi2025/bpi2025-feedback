<script>
document.getElementById("feedbackForm").onsubmit = function(e){
    e.preventDefault();

    var name = document.getElementById("name").value.trim();
    var affiliation = document.getElementById("affiliation").value.trim();
    var email = document.getElementById("email").value.trim().toLowerCase();
    var rating = document.getElementById("rating").value;
    var comment = document.getElementById("comment").value;

    // 1️⃣ CHECK EMAIL AUTHORIZATION
    fetch("https://script.google.com/macros/s/AKfycbyWCDkwectVdS-Jn4Z33K0LbyRbNLj-gyd6lmegkEFgeoucSz81-VXnLyvnePkt9-2x/exec", {
        method: "POST",
        body: JSON.stringify({ email: email })
    })
    .then(res => res.json())
    .then(result => {

        if (result.status !== "allowed") {
            alert("This email is not authorized to receive a certificate.");
            return;
        }

        // 2️⃣ SAVE FEEDBACK
        return fetch("https://script.google.com/macros/s/AKfycbx0gp1KKA70SkvYu5Kp4c02JLxyFlrvyQMOovozToWn5Z9jL8-eTUK4MrXVt5JZI3Wp/exec", {
            method: "POST",
            body: JSON.stringify({
                name: name,
                affiliation: affiliation,
                email: email,
                rating: rating,
                comment: comment
            })
        });
    })
    .then(() => {
        // 3️⃣ GENERATE CERTIFICATE
        window.location.href =
            "certificate.html?name=" + encodeURIComponent(name) +
            "&affiliation=" + encodeURIComponent(affiliation);
    })
    .catch(() => {
        alert("Submission failed. Please try again.");
    });
};
</script>
